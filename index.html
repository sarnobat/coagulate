<!DOCTYPE html>
<html>
<head>
<title>Coagulate (Content Management System)</title>
<link rel="shortcut icon" href="http://netgear.rohidekar.com/static/icons/Orb_Icons_001.png" type="image/x-icon" />

<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="http://jqueryui.com/jquery-wp-content/themes/jqueryui.com/style.css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="http://netgear.rohidekar.com/yurl/jquery/jquery-ui.js"></script>
<script type="text/javascript" src="http://netgear.rohidekar.com/yurl/jquery/purl.js"></script>
<script src="http://www.webtoolkit.info/djs/webtoolkit.md5.js"></script>
</script>
<script>


var urlBase = "http://netgear.rohidekar.com:4451/cmsfs/";
var limit;


$(function() {
	$( "#tabs" ).tabs();
});

function updateURLIfEmpty() {
	var locations = $.url().param('locations');
	if (locations == null || locations == '') {
			updateURL();
	} else {
		$("#locations").val(decodeURIComponent(locations));
	}

  	limit = $.url().param('limit');
	if (limit == null) {
			limit = 20;
			window.history.pushState("object or string", "Title", document.URL + "&limit=" + limit);
	}
}

function updateURL() {
	history.pushState(null, null, '/coagulate?locations=' + encodeURIComponent($("#locations").val())); // HTML5
}
// TODO: This code is nice and simple thanks to the functional refactorings. What would 
// be even better is if we could replace the loops with recursion.
$(document).ready(function(){

	updateURLIfEmpty();

	$.getJSON(urlBase + "/list?dirs=" + encodeURIComponent($("#locations").val()),function(response) {
		addSubdirLinks(response);
		{
			var items = response.items;
			{
				var html = "";
				var id = 0;
				// For each directory
				for(var dirIndex in items) { 
					var filesInDir = items[dirIndex];
					if (filesInDir.length < 1) {
						continue;
					}
					var filesInDirSortedMap = shuffle(Object.keys(filesInDir));
					// For each file in the directory
					for (var sortedIndex in filesInDirSortedMap) {
						var filepath = filesInDirSortedMap[sortedIndex];
						if (filepath.match(/.*(nohup.out$|Thumbs.db|[pP]icasa.ini)/)) {
							console.log('Skipping: ' + filepath);
							continue;
						}	
						++id;
						if (id > limit) {
							continue;
						}
						html += createItemHtml(response, filesInDirSortedMap[sortedIndex], dirIndex, id);
					}
				}
				$('#items').append(html);
				loadImagesSequentially(0);
			}
			{
				var html = printDirsRecursive(response.itemsRecursive, response);
				$('#thumbnailItems').append(html);
					
			}
		}
	});
});

function printDirsRecursive(items, response, idIn, categoryName) {
	var html = "";
	html += "<h3>" + categoryName + "</h3>";
	var id = 0;
	// For each directory
	for(var dirIndex in items) { 
		var filesInDir = items[dirIndex];
		if (filesInDir.length < 1) {
			continue;
		}
		var filesInDirSortedMap = shuffle(Object.keys(filesInDir));
		// For each file in the directory
		for (var sortedIndex in filesInDirSortedMap) {
			var filepath = filesInDirSortedMap[sortedIndex];
			if (filepath.match(/.*(nohup.out$|Thumbs.db|[pP]icasa.ini)/)) {
				console.log('Skipping: ' + filepath);
				continue;
			}
			if (filepath == 'dirs') {
				var categoryName1 = "";
				if (Object.keys(items)[sortedIndex]) {
					if (Object.keys(items)[sortedIndex].split('/')) {
						categoryName1 = Object.keys(items)[sortedIndex].split('/').pop();
					}
				} else {
					debugger;
				}
				
				html += printDirsRecursive(filesInDir['dirs'], response, idIn + "-" + id, categoryName1);
			} else {
				++id;
				if (id > limit) {
					continue;
				}
				html += createThumbnailItemHtml(response, filesInDirSortedMap[sortedIndex], dirIndex, idIn + "-" + id, filesInDir[filepath]);
			}
		}
	}
	return html;
}
function addSubdirLinks(response) {
	{
		for(var dirIndex in response.subdirectories) { 
			var filesInDir = response.subdirectories[dirIndex];

			if (filesInDir.length < 1) {
				continue;
			}
			for (var sortedIndex in filesInDir) {
				var filepath = filesInDir[sortedIndex];
				console.debug(filepath.fileSystem);
				$('#subdirs').append("<tr><td><a href='/coagulate/?locations=" +encodeURIComponent(filepath.fileSystem)+ "'>"+filepath.fileSystem+"</a></td></tr>");
			}
		}
	}	
}
function loadImagesSequentially(i) {
	var images = $('.myimage');
	if (i >= images.length) {
		return
	}

	var imageAttrs = images[i].attributes;
	var datasrc = $(images[i]).attr('data-src');
	$(images[i]).attr('src',datasrc);
	var a = function(j) {
		loadImagesSequentially(++i);
	};
	$(images[i]).load(a(i));

}

function createThumbnailItemHtml(response, item, key, id, itemDetails)				
{	
// height ensures buttons don't jump left and right between items for easier mass sorting. But it's not as nice to view
	var width = "250px";
	var height = "100px";
	
	{
		var res = item.match(/.*\.((txt)|(lnk))/gi);
		if (res !=null) {
			return;
		}
	}
	
	if (itemDetails == null) {
		debugger;
	}
	if (response.items == null) {
		debugger;
	}
	if (response.items[key] == null) {
		debugger;
	}
	var item2 = itemDetails;//response.items[key][item];
	{
		var toBeAppended = "";
		var httpUrl = item2.httpUrl;
		//console.debug(item2);
		var thumbnailUrl = item2.thumbnailUrl;
		{
			var lastModified = item2.lastModified;
			{
				var res = item.match(/.*\.((jpe?g)|(png)|(gif)|(bmp))/gi);
				if (res !=null) {
					toBeAppended += '<a href="' + httpUrl + '" target="_blank">';
					//toBeAppended += '<img width="'+width+'" class="myimage" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="' + httpUrl + '"/>';
					toBeAppended += '<img height="'+height+'" class="myimage" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="' + encodeURI(httpUrl) + '"/>';
					toBeAppended += '</a>';
				}
			}
		}
		{
			var matchesVideo = item.match(/.*((mp4)|(webm)|(mov)|(mkv)|(flv)|(avi))/gi);
			if (matchesVideo != null) {
				//toBeAppended = '&nbsp;<video width="'+width+'" controls="" muted=""><source type="video/mp4" src="' +httpUrl+ '"/></video>';
				toBeAppended += '<img src=\"' +thumbnailUrl+'\">';
			}
		}
		{
			var matchesVideo = item.match(/.*((pdf)|(tif))/gi);
			if (matchesVideo != null) {
				//toBeAppended = '&nbsp;<video width="'+width+'" controls="" muted=""><source type="video/mp4" src="' +httpUrl+ '"/></video>';
				toBeAppended += '<img src=\"' +thumbnailUrl+'\" height='+height+'>';
			}
		}
	}	
	var idstring = "i" + id;
	toBeAppended = "<a href='" +httpUrl+"'>" + toBeAppended + "</a>";
	toBeAppended += "&nbsp;";
	/*
	var localLink = "<a href=\"file://" + item2.fileSystem.toString() +"\">" + "Local Link" + "</a>";
	
	var toBeAppended =	  "<tr id='" +idstring+"'><td><table><tr><td>"
		+ toBeAppended + "<td><td>"+createButtonsPanel(item, response, key, idstring)
		+ "</td></tr><tr><td colspan=2><textarea rows=4 style='width:" + width+"; word-wrap:break-word;'>" 
		+ decodeURIComponent(item)+"</textarea><br>"+lastModified + "</td>"
		+ "<td><a href='" +httpUrl+"'>" + httpUrl + "</a><br>" +localLink
		+ "<br></td></tr></table></td></tr>";
*/
	console.debug(toBeAppended);
	return toBeAppended;
}


function createItemHtml(response, item, key, id)				
{	
	// height ensures buttons don't jump left and right between items for easier mass sorting. But it's not as nice to view
	var width = "250px";
	var height = "300px";
	
	{
		var res = item.match(/.*\.((txt)|(lnk))/gi);
		if (res !=null) {
			return;
		}
	}
	
	var item2 = response.items[key][item];
	{
		var toBeAppended = "";
		var httpUrl = item2.httpUrl;
		//console.debug(item2);
		var thumbnailUrl = item2.thumbnailUrl;
		{
			var lastModified = item2.lastModified;
			{
				var res = item.match(/.*\.((jpe?g)|(png)|(gif)|(bmp))/gi);
				if (res !=null) {
					toBeAppended += '<a href="' + httpUrl + '" target="_blank">';
					//toBeAppended += '<img width="'+width+'" class="myimage" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="' + httpUrl + '"/>';
					toBeAppended += '<img width="'+width+'" class="myimage" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="' + encodeURI(httpUrl) + '"/>';
					toBeAppended += '</a>';
				}
			}
		}
		{
			var matchesVideo = item.match(/.*((mp4)|(webm)|(mov)|(mkv)|(flv)|(avi))/gi);
			if (matchesVideo != null) {
				//toBeAppended = '&nbsp;<video width="'+width+'" controls="" muted=""><source type="video/mp4" src="' +httpUrl+ '"/></video>';
				toBeAppended += '<img src=\"' +thumbnailUrl+'\">';
			}
		}
		{
			var matchesVideo = item.match(/.*((pdf)|(tif))/gi);
			if (matchesVideo != null) {
				//toBeAppended = '&nbsp;<video width="'+width+'" controls="" muted=""><source type="video/mp4" src="' +httpUrl+ '"/></video>';
				toBeAppended += '<img src=\"' +thumbnailUrl+'\" width=200>';
			}
		}
	}	
	var idstring = "i" + id;
	
	var localLink = "<a href=\"file://" + item2.fileSystem.toString() +"\">" + "Local Link" + "</a>";
	
	//console.debug(localLink);
	var toBeAppended =	  "<tr id='" +idstring+"'><td><table><tr><td>"
		+ toBeAppended + "<td><td>"+createButtonsPanel(item, response, key, idstring)
		+ "</td></tr><tr><td colspan=2><textarea rows=4 style='width:" + width+"; word-wrap:break-word;'>" 
		+ decodeURIComponent(item)+"</textarea><br>"+lastModified + "</td>"
		+ "<td><a href='" +httpUrl+"'>" + httpUrl + "</a><br>" +localLink
		+ "<br></td></tr></table></td></tr>";

	return toBeAppended;
}

function createButtonsPanel(item, response, key, idstring) {

	var buttons = "<table><tr><td>";							
	{
		var escaped = item.replace(/'/g, "&apos;");
		buttons += "<button onclick='moveFileToParent(\"" + escaped + "\",\""+idstring+"\")'>Wrong Category</button><br>";
		var subdirs = response.locations[key].dirs;
		var subdirsArray = Object.keys(subdirs).sort(sortFunction);
		{
			var buttonsAdded = 0;
			for (var dir in subdirsArray) {
				buttonsAdded++;
				if (buttonsAdded%15 == 0) {
					buttons += "</td><td>";
				}
				var dirName = subdirsArray[dir];				
				buttons += "<button onmousedown='button.style.cssText = \"background-color : orange\";' onclick='moveFile(this, \"" + escaped + "\",\"" + dirName + "\",\""+idstring+"\")' style='background-color:"+getColorForDir(dirName)+"'>"+dirName+"</button><br>";
			}
		}
	}
	buttons += "<br>";
	buttons += "<button onclick='moveToNonExistingFolder(this,\"" +escaped+"\",\""+dirName+"\",\""+idstring+"\")'>MOVE to custom</button><br>";
	buttons += "<br>";
	buttons += "<button onclick='copyFileToFolder(\"" + escaped + "\", \"/media/sarnobat/e/Drive J/pictures/Other (new)/pictures/misc_sync_master/favorites\",\""+idstring+"\", this)'>COPY TO favorites</button><br>";
	buttons += "</td></tr></table>";
	return buttons;
}

function moveToNonExistingFolder(elem, fileToMove, parentDir, idstring) {
	var newCategorySimpleName = prompt("Category name:");
	var newDir = parentDir + '/' + newCategorySimpleName;
	moveFile(elem, fileToMove, newCategorySimpleName, idstring);
}

function moveFile(button, filePath, destinationDirSimpleName,id) {
	$.getJSON(urlBase + "/move?filePath="+encodeURIComponent(filePath) + "&destinationDirSimpleName=" + destinationDirSimpleName,function(response){
		$("#" + id).remove();
	});
}

function sortFunction(a, b) {
	if (a.toLowerCase() < b.toLowerCase()) return -1;
	if (a.toLowerCase() > b.toLowerCase()) return 1;
	return 0;
}
							
function getColorForDir(dirName) {								
	var color = "";
	if (dirName == 'other' || dirName == 'divas') {
		color = 'pink';
	} else if (dirName.match(/Atletico/i) || dirName == 'brst') {
		color = 'red';
	}
	else if (dirName.match(/Liverpool/i)) {
		color = 'red';
	}
	 else if (dirName == 'legs') {
		color = 'yellow';
	}  else if (dirName == 'navel') {
		color = 'purple';
	}  else if (dirName == 'teen') {
		color = 'lavender';
	} else if (dirName.match(/soccer/i)) {
		color = 'green';
	} else if (dirName == 'ind') {
		color = 'orange';
		console.debug('found ind');
	}
	return color
}

function addslashes( str ) {
    return (str + '').replace(/[\\"']/g, '\\$&').replace(/\u0000/g, '\\0');
}

function moveFileToParent(filePath, id) {
	$.getJSON(urlBase + "/moveToParent?filePath="+encodeURIComponent(filePath), function(response){
		$("#" + id).remove();
	});
}

function copyFileToFolder(filePath, destinationDirPath, id, button) {
	$.getJSON(urlBase + "/copyToFolder?filePath="+encodeURIComponent(filePath) + "&destinationDirPath=" + encodeURIComponent(destinationDirPath), function(response){
//		$("#" + id).css('background-color','green');
		$(button).css('background-color','green');
		$("#" + id).css('color','white');
	});
}

function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex ;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>
<style type="text/css">

.ui-widget {
	/* Reduces JQUery's default font size */
    font-size: 70%;
}

.ui-tabs .ui-tabs-panel {
	background-color : #FFE6EA;
}
</style>
</head>
<body style="background-color : #FFE6EA">


<script> 
    $(function(){
      $("#menubar").load("http://netgear.rohidekar.com/index.html"); 
    });
</script>
<div id="menubar"></div>

Todo: Create a tab for simply viewing the images in a directory (no sorting). e.g. for "favorites". Otherwise you have to manually add links to yurl
<br>
<a href="http://netgear.rohidekar.com/coagulate">Reset Locations</a><br>

<div id="tabs">
  <ul>
    <li><a href="#sorttab">Sort</a></li>
    <li><a href="#thumbnailtab">Thumbnails</a></li>
    <li><a href="#hoisttab">Hoist</a></li>
  </ul>
  <div id="sorttab">
    <table id="items"></table>
  </div>
  <div id="thumbnailtab">
      <table id="thumbnailItems"></table>
  </div>
  <div id="hoisttab">
  </div>
</div>


<table id="subdirs"></table>

Key bindings<br>
<textarea id="locations" cols="100" rows="30" onblur="updateURL()">
## Miscellaneous
/e/new
#/Users/sarnobat/Desktop

##
## Other
##

#/e/Drive J/pictures/Other (new)/pictures/misc_sync_master
#/media/sarnobat/Unsorted/images
#/Users/sarnobat/Windows/misc/ind
#/Users/sarnobat/Windows/misc/favorites
#/e/Drive J/pictures/Other (new)/pictures/misc_sync_master/teen/primejailbat.com

##
## Videos
##

/media/sarnobat/Unsorted/Videos/
/media/sarnobat/Large/Videos
#/media/sarnobat/Unsorted/Videos/wwf/
#/media/sarnobat/Unsorted/Videos/Atletico
#/media/sarnobat/Unsorted/Videos/soccer
#/media/sarnobat/Unsorted/Videos/Other

##
## Images
##

/e/Sridhar/Photos/camera phone photos/iPhone/2015-03-08
/e/Sridhar/Photos/2003 and before - Pre Digital Camera/scans - unsorted
/e/new/screenshots
#/e/new/photos_iphone_white/20150313-203901
#/e/Sridhar/Photos/Courtesy of others/dad	
#/e/Sridhar/Photos/camera phone photos/iPhone/Sridhar
#/e/Sridhar/Photos/camera phone photos/iPhone
#/media/sarnobat/e/new/Starred_photos
#/media/sarnobat/e/Sridhar/Photos/2014-10-11 Santa Cruz with Murali

##
## Pdf
##

#/media/sarnobat/Record/Record to DVD (non-videos)/books
#/e/new/pdf

##
## Audio
##

#/media/sarnobat/e/Sridhar/Audio - THIS IS NOT THE MASTER COPY, SO ITS POINTLESS
</textarea>

<br><br>
<button>get urls</button>

</body>
</html>
